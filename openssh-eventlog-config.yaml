# OpenTelemetry Collector Configuration for Windows OpenSSH Event Log
# This configuration ingests OpenSSH operational logs and transforms them to human-readable format

receivers:
  windowseventlog/openssh:
    channel: OpenSSH/Operational
    max_reads: 100
    start_at: end
    poll_interval: 1s
    attributes:
      log.source: "windows.openssh"
    raw: true  # Get raw XML for full parsing

processors:
  # Extract and parse EventData XML fields
  transform/openssh_eventdata:
    log_statements:
      - context: log
        statements:
          # Extract event record ID
          - set(attributes["event.record_id"], body["Event"]["System"]["EventRecordID"]) where body["Event"]["System"]["EventRecordID"] != nil

          # Extract provider name
          - set(attributes["event.provider"], body["Event"]["System"]["Provider"]["@Name"]) where body["Event"]["System"]["Provider"]["@Name"] != nil

          # Extract event ID
          - set(attributes["event.id"], body["Event"]["System"]["EventID"]) where body["Event"]["System"]["EventID"] != nil

          # Extract event level
          - set(attributes["event.level"], body["Event"]["System"]["Level"]) where body["Event"]["System"]["Level"] != nil

          # Extract computer name
          - set(attributes["host.name"], body["Event"]["System"]["Computer"]) where body["Event"]["System"]["Computer"] != nil

          # Extract user SID
          - set(attributes["user.sid"], body["Event"]["System"]["Security"]["@UserID"]) where body["Event"]["System"]["Security"]["@UserID"] != nil

          # Extract time created
          - set(attributes["event.created"], body["Event"]["System"]["TimeCreated"]["@SystemTime"]) where body["Event"]["System"]["TimeCreated"]["@SystemTime"] != nil

          # Extract process ID
          - set(attributes["process.pid"], body["Event"]["System"]["Execution"]["@ProcessID"]) where body["Event"]["System"]["Execution"]["@ProcessID"] != nil

  # Transform Event IDs to human-readable descriptions
  transform/openssh_event_descriptions:
    log_statements:
      - context: log
        statements:
          # SSH Server Service Events (Event IDs 1-10)
          - set(attributes["event.description"], "sshd service started") where attributes["event.id"] == "1"
          - set(attributes["event.category"], "SSH Service") where attributes["event.id"] == "1"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "1"
          - set(attributes["event.action"], "service_started") where attributes["event.id"] == "1"

          - set(attributes["event.description"], "sshd service stopped") where attributes["event.id"] == "2"
          - set(attributes["event.category"], "SSH Service") where attributes["event.id"] == "2"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "2"
          - set(attributes["event.action"], "service_stopped") where attributes["event.id"] == "2"

          - set(attributes["event.description"], "sshd service start failed") where attributes["event.id"] == "3"
          - set(attributes["event.category"], "SSH Service") where attributes["event.id"] == "3"
          - set(attributes["event.severity"], "error") where attributes["event.id"] == "3"
          - set(attributes["event.action"], "service_start_failed") where attributes["event.id"] == "3"

          - set(attributes["event.description"], "sshd configuration error") where attributes["event.id"] == "4"
          - set(attributes["event.category"], "SSH Service") where attributes["event.id"] == "4"
          - set(attributes["event.severity"], "error") where attributes["event.id"] == "4"

          # SSH Connection Events (Event IDs 11-20)
          - set(attributes["event.description"], "SSH connection accepted") where attributes["event.id"] == "11"
          - set(attributes["event.category"], "SSH Connection") where attributes["event.id"] == "11"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "11"
          - set(attributes["event.action"], "connection_accepted") where attributes["event.id"] == "11"

          - set(attributes["event.description"], "SSH connection closed") where attributes["event.id"] == "12"
          - set(attributes["event.category"], "SSH Connection") where attributes["event.id"] == "12"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "12"
          - set(attributes["event.action"], "connection_closed") where attributes["event.id"] == "12"

          - set(attributes["event.description"], "SSH connection failed") where attributes["event.id"] == "13"
          - set(attributes["event.category"], "SSH Connection") where attributes["event.id"] == "13"
          - set(attributes["event.severity"], "warning") where attributes["event.id"] == "13"
          - set(attributes["event.action"], "connection_failed") where attributes["event.id"] == "13"

          - set(attributes["event.description"], "SSH connection timeout") where attributes["event.id"] == "14"
          - set(attributes["event.category"], "SSH Connection") where attributes["event.id"] == "14"
          - set(attributes["event.severity"], "warning") where attributes["event.id"] == "14"
          - set(attributes["event.action"], "connection_timeout") where attributes["event.id"] == "14"

          # SSH Authentication Events (Event IDs 21-35)
          - set(attributes["event.description"], "SSH authentication successful") where attributes["event.id"] == "21"
          - set(attributes["event.category"], "SSH Authentication") where attributes["event.id"] == "21"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "21"
          - set(attributes["event.action"], "auth_success") where attributes["event.id"] == "21"

          - set(attributes["event.description"], "SSH authentication failed") where attributes["event.id"] == "22"
          - set(attributes["event.category"], "SSH Authentication") where attributes["event.id"] == "22"
          - set(attributes["event.severity"], "warning") where attributes["event.id"] == "22"
          - set(attributes["event.action"], "auth_failed") where attributes["event.id"] == "22"

          - set(attributes["event.description"], "SSH public key authentication successful") where attributes["event.id"] == "23"
          - set(attributes["event.category"], "SSH Authentication") where attributes["event.id"] == "23"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "23"
          - set(attributes["event.action"], "pubkey_auth_success") where attributes["event.id"] == "23"

          - set(attributes["event.description"], "SSH public key authentication failed") where attributes["event.id"] == "24"
          - set(attributes["event.category"], "SSH Authentication") where attributes["event.id"] == "24"
          - set(attributes["event.severity"], "warning") where attributes["event.id"] == "24"
          - set(attributes["event.action"], "pubkey_auth_failed") where attributes["event.id"] == "24"

          - set(attributes["event.description"], "SSH password authentication successful") where attributes["event.id"] == "25"
          - set(attributes["event.category"], "SSH Authentication") where attributes["event.id"] == "25"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "25"
          - set(attributes["event.action"], "password_auth_success") where attributes["event.id"] == "25"

          - set(attributes["event.description"], "SSH password authentication failed") where attributes["event.id"] == "26"
          - set(attributes["event.category"], "SSH Authentication") where attributes["event.id"] == "26"
          - set(attributes["event.severity"], "warning") where attributes["event.id"] == "26"
          - set(attributes["event.action"], "password_auth_failed") where attributes["event.id"] == "26"

          - set(attributes["event.description"], "SSH keyboard-interactive authentication successful") where attributes["event.id"] == "27"
          - set(attributes["event.category"], "SSH Authentication") where attributes["event.id"] == "27"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "27"
          - set(attributes["event.action"], "kbdint_auth_success") where attributes["event.id"] == "27"

          - set(attributes["event.description"], "SSH keyboard-interactive authentication failed") where attributes["event.id"] == "28"
          - set(attributes["event.category"], "SSH Authentication") where attributes["event.id"] == "28"
          - set(attributes["event.severity"], "warning") where attributes["event.id"] == "28"
          - set(attributes["event.action"], "kbdint_auth_failed") where attributes["event.id"] == "28"

          - set(attributes["event.description"], "SSH GSSAPI authentication successful") where attributes["event.id"] == "29"
          - set(attributes["event.category"], "SSH Authentication") where attributes["event.id"] == "29"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "29"
          - set(attributes["event.action"], "gssapi_auth_success") where attributes["event.id"] == "29"

          - set(attributes["event.description"], "SSH GSSAPI authentication failed") where attributes["event.id"] == "30"
          - set(attributes["event.category"], "SSH Authentication") where attributes["event.id"] == "30"
          - set(attributes["event.severity"], "warning") where attributes["event.id"] == "30"
          - set(attributes["event.action"], "gssapi_auth_failed") where attributes["event.id"] == "30"

          - set(attributes["event.description"], "SSH too many authentication failures") where attributes["event.id"] == "31"
          - set(attributes["event.category"], "SSH Authentication") where attributes["event.id"] == "31"
          - set(attributes["event.severity"], "error") where attributes["event.id"] == "31"
          - set(attributes["event.action"], "auth_max_attempts") where attributes["event.id"] == "31"

          # SSH Session Events (Event IDs 40-50)
          - set(attributes["event.description"], "SSH session opened") where attributes["event.id"] == "40"
          - set(attributes["event.category"], "SSH Session") where attributes["event.id"] == "40"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "40"
          - set(attributes["event.action"], "session_opened") where attributes["event.id"] == "40"

          - set(attributes["event.description"], "SSH session closed") where attributes["event.id"] == "41"
          - set(attributes["event.category"], "SSH Session") where attributes["event.id"] == "41"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "41"
          - set(attributes["event.action"], "session_closed") where attributes["event.id"] == "41"

          - set(attributes["event.description"], "SSH command executed") where attributes["event.id"] == "42"
          - set(attributes["event.category"], "SSH Session") where attributes["event.id"] == "42"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "42"
          - set(attributes["event.action"], "command_executed") where attributes["event.id"] == "42"

          - set(attributes["event.description"], "SSH shell started") where attributes["event.id"] == "43"
          - set(attributes["event.category"], "SSH Session") where attributes["event.id"] == "43"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "43"
          - set(attributes["event.action"], "shell_started") where attributes["event.id"] == "43"

          - set(attributes["event.description"], "SSH subsystem request") where attributes["event.id"] == "44"
          - set(attributes["event.category"], "SSH Session") where attributes["event.id"] == "44"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "44"
          - set(attributes["event.action"], "subsystem_request") where attributes["event.id"] == "44"

          # SSH Port Forwarding Events (Event IDs 51-60)
          - set(attributes["event.description"], "SSH port forwarding request granted") where attributes["event.id"] == "51"
          - set(attributes["event.category"], "SSH Port Forwarding") where attributes["event.id"] == "51"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "51"
          - set(attributes["event.action"], "port_forward_granted") where attributes["event.id"] == "51"

          - set(attributes["event.description"], "SSH port forwarding request denied") where attributes["event.id"] == "52"
          - set(attributes["event.category"], "SSH Port Forwarding") where attributes["event.id"] == "52"
          - set(attributes["event.severity"], "warning") where attributes["event.id"] == "52"
          - set(attributes["event.action"], "port_forward_denied") where attributes["event.id"] == "52"

          - set(attributes["event.description"], "SSH tunnel opened") where attributes["event.id"] == "53"
          - set(attributes["event.category"], "SSH Port Forwarding") where attributes["event.id"] == "53"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "53"
          - set(attributes["event.action"], "tunnel_opened") where attributes["event.id"] == "53"

          - set(attributes["event.description"], "SSH tunnel closed") where attributes["event.id"] == "54"
          - set(attributes["event.category"], "SSH Port Forwarding") where attributes["event.id"] == "54"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "54"
          - set(attributes["event.action"], "tunnel_closed") where attributes["event.id"] == "54"

          # SSH Key Management Events (Event IDs 61-70)
          - set(attributes["event.description"], "SSH host key generated") where attributes["event.id"] == "61"
          - set(attributes["event.category"], "SSH Key Management") where attributes["event.id"] == "61"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "61"
          - set(attributes["event.action"], "hostkey_generated") where attributes["event.id"] == "61"

          - set(attributes["event.description"], "SSH host key loaded") where attributes["event.id"] == "62"
          - set(attributes["event.category"], "SSH Key Management") where attributes["event.id"] == "62"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "62"
          - set(attributes["event.action"], "hostkey_loaded") where attributes["event.id"] == "62"

          - set(attributes["event.description"], "SSH authorized key loaded") where attributes["event.id"] == "63"
          - set(attributes["event.category"], "SSH Key Management") where attributes["event.id"] == "63"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "63"
          - set(attributes["event.action"], "authkey_loaded") where attributes["event.id"] == "63"

          - set(attributes["event.description"], "SSH key exchange completed") where attributes["event.id"] == "64"
          - set(attributes["event.category"], "SSH Key Management") where attributes["event.id"] == "64"
          - set(attributes["event.severity"], "info") where attributes["event.id"] == "64"
          - set(attributes["event.action"], "key_exchange_completed") where attributes["event.id"] == "64"

          # Default for unknown events
          - set(attributes["event.description"], "OpenSSH event") where attributes["event.description"] == nil
          - set(attributes["event.category"], "SSH") where attributes["event.category"] == nil

  # Parse EventData fields
  transform/openssh_eventdata_fields:
    log_statements:
      - context: log
        statements:
          # Extract user information
          - set(attributes["ssh.user"], body["Event"]["EventData"]["User"]) where body["Event"]["EventData"]["User"] != nil
          - set(attributes["ssh.user"], body["Event"]["EventData"]["UserName"]) where body["Event"]["EventData"]["UserName"] != nil

          # Extract source IP and port
          - set(attributes["source.ip"], body["Event"]["EventData"]["SourceIP"]) where body["Event"]["EventData"]["SourceIP"] != nil
          - set(attributes["source.ip"], body["Event"]["EventData"]["ClientIP"]) where body["Event"]["EventData"]["ClientIP"] != nil
          - set(attributes["source.port"], body["Event"]["EventData"]["SourcePort"]) where body["Event"]["EventData"]["SourcePort"] != nil
          - set(attributes["source.port"], body["Event"]["EventData"]["ClientPort"]) where body["Event"]["EventData"]["ClientPort"] != nil

          # Extract destination IP and port
          - set(attributes["destination.ip"], body["Event"]["EventData"]["DestinationIP"]) where body["Event"]["EventData"]["DestinationIP"] != nil
          - set(attributes["destination.port"], body["Event"]["EventData"]["DestinationPort"]) where body["Event"]["EventData"]["DestinationPort"] != nil

          # Extract authentication method
          - set(attributes["ssh.auth_method"], body["Event"]["EventData"]["AuthMethod"]) where body["Event"]["EventData"]["AuthMethod"] != nil
          - set(attributes["ssh.auth_method"], body["Event"]["EventData"]["Method"]) where body["Event"]["EventData"]["Method"] != nil

          # Extract session ID
          - set(attributes["ssh.session_id"], body["Event"]["EventData"]["SessionID"]) where body["Event"]["EventData"]["SessionID"] != nil

          # Extract command
          - set(attributes["ssh.command"], body["Event"]["EventData"]["Command"]) where body["Event"]["EventData"]["Command"] != nil

          # Extract error/reason
          - set(attributes["ssh.error"], body["Event"]["EventData"]["Error"]) where body["Event"]["EventData"]["Error"] != nil
          - set(attributes["ssh.reason"], body["Event"]["EventData"]["Reason"]) where body["Event"]["EventData"]["Reason"] != nil

          # Extract protocol version
          - set(attributes["ssh.protocol_version"], body["Event"]["EventData"]["ProtocolVersion"]) where body["Event"]["EventData"]["ProtocolVersion"] != nil

          # Extract cipher information
          - set(attributes["ssh.cipher"], body["Event"]["EventData"]["Cipher"]) where body["Event"]["EventData"]["Cipher"] != nil

          # Extract key type
          - set(attributes["ssh.key_type"], body["Event"]["EventData"]["KeyType"]) where body["Event"]["EventData"]["KeyType"] != nil
          - set(attributes["ssh.key_fingerprint"], body["Event"]["EventData"]["KeyFingerprint"]) where body["Event"]["EventData"]["KeyFingerprint"] != nil

          # Extract subsystem name
          - set(attributes["ssh.subsystem"], body["Event"]["EventData"]["Subsystem"]) where body["Event"]["EventData"]["Subsystem"] != nil

  # Map to Splunk CIM fields
  transform/openssh_cim:
    log_statements:
      - context: log
        statements:
          # Vendor/Product identification
          - set(attributes["vendor_product"], "Microsoft Windows")
          - set(attributes["vendor"], "Microsoft")
          - set(attributes["product"], "Windows")
          # CIM Destination
          - set(attributes["dest"], attributes["host.name"]) where attributes["host.name"] != nil
          # CIM Signature
          - set(attributes["signature"], attributes["event.description"]) where attributes["event.description"] != nil
          - set(attributes["signature_id"], attributes["event.id"]) where attributes["event.id"] != nil
          # CIM Action
          - set(attributes["action"], attributes["event.action"]) where attributes["event.action"] != nil
          # CIM App
          - set(attributes["app"], attributes["event.provider"]) where attributes["event.provider"] != nil

  # Map to Google SecOps UDM fields
  transform/openssh_udm:
    log_statements:
      - context: log
        statements:
          # UDM Metadata
          - set(attributes["metadata.vendor_name"], "Microsoft")
          - set(attributes["metadata.product_name"], "Windows")
          - set(attributes["metadata.log_type"], "WINEVTLOG")
          # UDM Principal
          - set(attributes["principal.hostname"], attributes["host.name"]) where attributes["host.name"] != nil
          # UDM Target
          - set(attributes["target.hostname"], attributes["host.name"]) where attributes["host.name"] != nil
          # UDM Security Result
          - set(attributes["security_result.summary"], attributes["event.description"]) where attributes["event.description"] != nil


exporters:
  # Configure your desired exporter here
  logging:
    verbosity: detailed

  # Example: Export to OTLP endpoint
  # otlp:
  #   endpoint: "your-otlp-endpoint:4317"
  #   tls:
  #     insecure: false

  # Example: Export to file
  # file:
  #   path: ./openssh-events.json

service:
  pipelines:
    logs:
      receivers: [windowseventlog/openssh]
      processors:
        - transform/openssh_eventdata
        - transform/openssh_event_descriptions
        - transform/openssh_eventdata_fields
        - transform/openssh_cim
        - transform/openssh_udm
      exporters: [logging]
